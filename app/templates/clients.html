<!-- Client management view expects a list of clients plus optional query string search parameter. -->
{% extends 'base.html' %}

{% block title %}GroundMatch • Clients{% endblock %}

{% block content %}
<section class="stack">
  {% if sample_clients %}
    <div class="section-note">Er worden fictieve clients getoond. Voeg echte clients toe om dit overzicht te vervangen.</div>
  {% endif %}
  <header class="page-header">
    <div>
      <h1>Client Management</h1>
      <p class="text-muted">Maintain every construction partner and their latest contact details.</p>
    </div>
    <a class="btn btn-primary" href="{{ url_for('main.create_client') }}"><i class="bi bi-plus-lg"></i> Add Client</a>
  </header>

  <form class="card search-bar" method="get" action="{{ url_for('main.manage_clients') }}">
    <div style="flex:1;">
      <label for="client_search" class="text-muted">Search clients</label>
      <input class="input" type="search" id="client_search" name="q" placeholder="Search by name or email" value="{{ request.args.get('q', '') }}">
    </div>
    <button class="btn btn-primary" type="submit">Search</button>
  </form>

  <div class="client-list">
    {% for client in clients %}
      <article class="card client-card">
        <div class="client-card__header">
          <div>
            <h2>{{ client.name }}</h2>
            <p class="text-muted">{{ client.email }}</p>
          </div>
          <div class="client-tags">
            <span class="badge-status info">{{ client.match_count if client.match_count is defined else (client.matches|length if client.matches is defined else 0) }} matches</span>
            <span class="badge-status success">{{ client.active_matches if client.active_matches is defined else 0 }} active</span>
          </div>
        </div>
        <div class="client-card__meta">
          <span><i class="bi bi-geo-alt"></i> {{ client.address or 'No address on file' }}</span>
          <span><i class="bi bi-chat-left-text"></i> Preferred soil: {{ client.preferences.soil if client.preferences is defined and client.preferences else '—' }}</span>
        </div>
        {% set pref_data = client.preferences if client.preferences else None %}
        <div class="card-section">
          <p style="font-weight:600; margin-bottom:0.5rem;">Preference Snapshot</p>
          {% if pref_data %}
            <div class="summary-grid">
              <div>
                <p class="text-muted">Location</p>
                <p>{{ pref_data.location or '—' }}</p>
              </div>
              <div>
                <p class="text-muted">Surface</p>
                <p>{{ pref_data.min_m2 or '—' }} – {{ pref_data.max_m2 or '—' }} m²</p>
              </div>
              <div>
                <p class="text-muted">Budget</p>
                <p>€{{ pref_data.min_budget or '—' }} – €{{ pref_data.max_budget or '—' }}</p>
              </div>
              <div>
                <p class="text-muted">Type</p>
                <p>{{ pref_data.subdivision_type or '—' }} • {{ pref_data.soil or '—' }}</p>
              </div>
            </div>
          {% else %}
            <p class="text-muted">No preferences configured yet.</p>
          {% endif %}
        </div>
        <div class="card-section">
          <p class="text-muted" style="margin-bottom:0.5rem;">Quick actions</p>
          <div class="client-actions">
            <a class="btn btn-outline" href="{{ url_for('main.edit_client', client_id=client.id) if not sample_clients else '#' }}" {% if sample_clients %}aria-disabled="true"{% endif %}>
              <i class="bi bi-eye"></i> View
            </a>
            <a class="btn btn-primary" href="{{ url_for('main.edit_client', client_id=client.id) if not sample_clients else '#' }}" {% if sample_clients %}aria-disabled="true"{% endif %}>
              <i class="bi bi-pencil"></i> Edit
            </a>
            {% set pref_url = url_for('main.preferences_dashboard', client_id=client.id if client.id is defined else client['id']) %}
            {% set pref_label = 'Edit Preferences' if pref_data else 'Add Preferences' %}
            <a class="btn btn-outline" href="{{ pref_url if not sample_clients else '#' }}" {% if sample_clients %}aria-disabled="true"{% endif %}>
              <i class="bi bi-sliders"></i> {{ pref_label }}
            </a>
            {% if not sample_clients %}
              <form method="post" action="{{ url_for('main.delete_client', client_id=client.id) }}" onsubmit="return confirm('Delete {{ client.name }}?');">
                <!-- csrf token placeholder -->
                <button class="btn btn-danger" type="submit"><i class="bi bi-trash"></i> Delete</button>
              </form>
            {% endif %}
          </div>
        </div>
      </article>
    {% else %}
      <article class="card">
        <p>No clients yet. Use “Add Client” to onboard your first partner.</p>
      </article>
    {% endfor %}
  </div>
</section>
{% endblock %}
