{% extends "base.html" %}
{% block content %}
<div class="card">
    <div class="matches-header">
        <div>
            <h1>Matches</h1>
            <div class="muted">View matches grouped by client — top results first</div>
        </div>
        <div class="matches-actions">
            {% if session.role == 'company' %}
            <a href="{{ url_for('dashboard') }}" class="btn">Back to dashboard</a>
            <form action="{{ url_for('match_run') }}" method="post" class="inline-form">
                <button type="submit" class="btn primary">Run matching</button>
            </form>
            {% elif session.role == 'client' %}
            <a href="{{ url_for('client_dashboard') }}" class="btn">Back to dashboard</a>
            {% endif %}
        </div>
    </div>

    {% if session.role == 'client' and client and client.company %}
    <div class="company-info-box">
        <strong>Company Contact Information:</strong><br>
        <small>Email: {{ client.company.email or 'Not available' }}</small>
    </div>
    {% endif %}

    {% if session.role == 'company' and clients %}
    <form method="GET" class="client-filter-form">
        <label>Filter per klant:</label>
        <select name="client_id" onchange="this.form.submit()">
            <option value="">Alle klanten</option>
            {% for c in clients %}
            <option value="{{ c.id }}" {% if client_filter and c.id == client_filter|int %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
        {% if client_filter %}
        <a href="{{ url_for('matches_list') }}" class="btn btn-small">Toon alles</a>
        {% endif %}
    </form>
    {% endif %}

    <div class="matches-container">
        {# Group matches by client (A → Z) and show top 10 per client #}
        {% set seen_clients = [] %}
        {% for match in matches|sort(attribute='client.name') %}
            {% if match.client and (match.client.name not in seen_clients) %}
                {% set _ = seen_clients.append(match.client.name) %}
                <div class="card matches-group">
                    <div class="matches-group-header">
                        <h4>{{ match.client.name }}</h4>
                        <div class="muted">Top {{ matches|selectattr('client.name','equalto', match.client.name)|list|length }} matches</div>
                    </div>
                    <div class="match-cards-grid">
                        {% set client_matches = matches|selectattr('client.name','equalto', match.client.name)|list %}
                        {% for cm in client_matches[:10] %}
                            <a href="{{ url_for('ground_detail', ground_id=cm.ground.id) }}" class="match-card-link">
                                <div class="card match-card">
                                    <div class="match-card-content">
                                        <img src="{% if cm.ground.photo_url %}{{ cm.ground.photo_url }}{% elif cm.ground.image_url %}{{ cm.ground.image_url }}{% else %}{{ url_for('ground_image', ground_id=cm.ground.id) }}{% endif %}" alt="{{ cm.ground.location }}" class="match-card-image">
                                        <div class="match-card-info">
                                            <div class="match-card-location">{{ cm.ground.location }}</div>
                                            <div class="muted">{{ cm.ground.m2|format_number }} m² • €{{ cm.ground.budget|format_price }} • {{ cm.ground.subdivision_type.replace('_', ' ').title() }}</div>
                                        </div>
                                        <div class="match-card-actions">
                                            <div class="tag info match-score">{{ cm|match_percent }}%</div>
                                            {% set s = (cm.status or '')|lower %}
                                            {{ s|status_badge }}
                                            {% if session.role == 'company' %}
                                                <form method="post" action="{{ url_for('match_toggle', match_id=cm.id, client_id=client_filter) }}" class="match-action-form">
                                                    {% if s == 'pending' %}
                                                        <button type="submit" name="action" value="approve" class="btn btn-small" onclick="event.stopPropagation();" onmousedown="event.stopPropagation();" onmouseup="event.stopPropagation();">Approve</button>
                                                    {% elif s in ['approved','accepted'] %}
                                                        <button type="submit" name="action" value="pending" class="btn btn-small" onclick="event.stopPropagation();" onmousedown="event.stopPropagation();" onmouseup="event.stopPropagation();">Set pending</button>
                                                    {% endif %}
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}
