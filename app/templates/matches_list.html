{% extends "base.html" %}
{% block content %}
<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
            <h1 style="margin:0 0 6px">Matches</h1>
            <div class="muted">View matches grouped by client — top results first</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
            {% if session.role == 'company' %}
            <a href="{{ url_for('dashboard') }}" class="btn">Back to dashboard</a>
            {% elif session.role == 'client' %}
            <a href="{{ url_for('client_dashboard') }}" class="btn">Back to dashboard</a>
            {% endif %}
        </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="display:flex;gap:8px">
            <a href="{{ url_for('matches_list') }}" class="btn">All</a>
            <a href="{{ url_for('matches_list', status='pending') }}" class="btn">Pending</a>
            <a href="{{ url_for('matches_list', status='accepted') }}" class="btn">Accepted</a>
            <a href="{{ url_for('matches_list', status='rejected') }}" class="btn">Rejected</a>
        </div>
    </div>

    <div>
        {# Group matches by client (A → Z) and show top 10 per client #}
        {% set seen_clients = [] %}
        {% for match in matches|sort(attribute='client.name') %}
            {% if match.client and (match.client.name not in seen_clients) %}
                {% set _ = seen_clients.append(match.client.name) %}
                <div class="card" style="margin-bottom:18px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <h4 style="margin:0">{{ match.client.name }}</h4>
                        <div class="muted">Top {{ matches|selectattr('client.name','equalto', match.client.name)|list|length }} matches</div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px">
                        {% set client_matches = matches|selectattr('client.name','equalto', match.client.name)|list %}
                        {% set client_matches = client_matches|sort(attribute='total_score', reverse=true) %}
                        {% for cm in client_matches[:10] %}
                            <a href="{{ url_for('ground_detail', ground_id=cm.ground.id) }}" style="text-decoration:none;color:inherit;display:block">
                                <div class="card" style="padding:12px;cursor:pointer;transition:box-shadow 0.2s ease">
                                    <div style="display:flex;align-items:center;gap:12px">
                                        <img src="/static/images/grounds/{{ cm.ground.id }}.jpg" alt="{{ cm.ground.location }}" style="width:110px;height:72px;object-fit:cover;border-radius:6px">
                                        <div style="flex:1">
                                            <div style="font-weight:700">{{ cm.ground.location }}</div>
                                            <div class="muted">{{ cm.ground.m2 }} m² • €{{ cm.ground.budget|format_price }} • {{ cm.ground.subdivision_type }}</div>
                                        </div>
                                        <div style="text-align:right">
                                            {# Show original backend-provided score value (may exceed 100%) #}
                                            <div class="tag info" style="font-size:16px;font-weight:600">{{ (cm.total_score if cm.total_score is defined else ((cm.budget_score or 0) + (cm.m2_score or 0) + (cm.location_score or 0)))|round(0)|int }}%</div>
                                            <div class="muted" style="margin-top:6px">{{ cm.status }}</div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}
